name: Publish Video

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"

concurrency:
  group: publish-video
  cancel-in-progress: false

jobs:

  # ==========================================================
  # MAIN PUBLISH PIPELINE
  # ==========================================================

  publish:
    runs-on: ubuntu-latest
    timeout-minutes: 70

    env:
      PYTHONUNBUFFERED: "1"
      GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
      HF_TOKEN: ${{ secrets.HF_TOKEN }}
      YT_CLIENT_ID: ${{ secrets.YT_CLIENT_ID }}
      YT_CLIENT_SECRET: ${{ secrets.YT_CLIENT_SECRET }}
      YT_REFRESH_TOKEN: ${{ secrets.YT_REFRESH_TOKEN }}
      YT_CHANNEL_ID: ${{ secrets.YT_CHANNEL_ID }}

    steps:

      # -----------------------------------
      # CHECKOUT
      # -----------------------------------

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # -----------------------------------
      # PYTHON SETUP WITH CACHE
      # -----------------------------------

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: "pip"

      # -----------------------------------
      # SYSTEM DEPENDENCIES
      # -----------------------------------

      - name: Install system dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y \
            ffmpeg \
            espeak-ng \
            espeak-ng-data \
            libespeak-ng1

      # -----------------------------------
      # PYTHON DEPENDENCIES (CACHED)
      # -----------------------------------

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install \
            papermill \
            jupyter \
            requests \
            google-api-python-client \
            google-auth \
            google-auth-oauthlib \
            pillow \
            moviepy \
            groq \
            torch==2.1.0 \
            torchaudio==2.1.0 \
            soundfile \
            transformers==4.35.2 \
            "coqui-tts[codec]"

      # -----------------------------------
      # STEP 1: PICK TOPIC
      # -----------------------------------

      - name: Pick topic
        run: python scripts/pick_topic.py

      - name: Upload current topic artifact
        uses: actions/upload-artifact@v4
        with:
          name: current_topic
          path: current_topic.json

      # -----------------------------------
      # STEP 2: VALIDATE CONVICTION
      # -----------------------------------

      - name: Validate topic conviction
        run: |
          if [ -f scripts/validate_topic_conviction.py ]; then
            python scripts/validate_topic_conviction.py
          else
            echo "validate_topic_conviction.py not found — skipping"
          fi

      # -----------------------------------
      # STEP 3: GENERATE SLIDES
      # -----------------------------------

      - name: Generate slide plan
        run: python scripts/generate_slides.py

      # -----------------------------------
      # STEP 4: GENERATE NARRATION
      # -----------------------------------

      - name: Generate narration
        run: python scripts/generate_narration.py

      # -----------------------------------
      # STEP 5: STORYCRAFT VALIDATION
      # -----------------------------------

      - name: Validate storycraft
        run: |
          if [ -f scripts/validate_storycraft.py ]; then
            python scripts/validate_storycraft.py
          else
            echo "validate_storycraft.py not found — skipping"
          fi

      # -----------------------------------
      # STEP 6: OUTPUT VALIDATION
      # -----------------------------------

      - name: Validate output
        run: python scripts/validate_output.py

      # -----------------------------------
      # STEP 7: RENDER VIDEO
      # -----------------------------------

      - name: Render video
        run: python scripts/call_colab.py

      # -----------------------------------
      # STEP 8: SUBTITLES
      # -----------------------------------

      - name: Generate subtitles
        run: python scripts/generate_subtitles.py

      # -----------------------------------
      # STEP 9: THUMBNAIL
      # -----------------------------------

      - name: Generate thumbnail
        run: python scripts/generate_thumbnail.py

      # -----------------------------------
      # STEP 10: UPLOAD TO YOUTUBE
      # -----------------------------------

      - name: Upload to YouTube
        run: python scripts/upload_youtube.py

      # Persist video_id
      - name: Upload latest_video artifact
        uses: actions/upload-artifact@v4
        with:
          name: latest_video
          path: latest_video.json

      - name: Upload publish metadata
        uses: actions/upload-artifact@v4
        with:
          name: publish_outputs
          path: |
            script.txt
            slide_plan.json
            slide_audio_map.json

      # -----------------------------------
      # STEP 11: MARK TOPIC DONE
      # -----------------------------------

      - name: Mark topic done
        run: python scripts/mark_done.py

      # -----------------------------------
      # CLEANUP
      # -----------------------------------

      - name: Cleanup workspace
        if: always()
        run: |
          rm -f *.png *.wav *.mp4 *.srt
          rm -f slide_plan.json slide_audio_map.json script.txt

  # ==========================================================
  # ADAPTIVE INTELLIGENCE LOOP
  # ==========================================================

  adaptive_feedback:
    needs: publish
    if: success()
    runs-on: ubuntu-latest
    timeout-minutes: 40

    env:
      PYTHONUNBUFFERED: "1"
      YT_CLIENT_ID: ${{ secrets.YT_CLIENT_ID }}
      YT_CLIENT_SECRET: ${{ secrets.YT_CLIENT_SECRET }}
      YT_REFRESH_TOKEN: ${{ secrets.YT_REFRESH_TOKEN }}

    steps:

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python (cached)
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: "pip"

      - name: Install minimal analytics dependencies
        run: |
          python -m pip install --upgrade pip
          pip install google-api-python-client google-auth google-auth-oauthlib

      # -----------------------------------
      # RESTORE ARTIFACTS
      # -----------------------------------

      - name: Download latest video ID
        uses: actions/download-artifact@v4
        with:
          name: latest_video

      - name: Download publish outputs
        uses: actions/download-artifact@v4
        with:
          name: publish_outputs

      # -----------------------------------
      # WAIT FOR ANALYTICS STABILITY
      # -----------------------------------

      - name: Wait for analytics stabilization
        run: sleep 900

      # -----------------------------------
      # EXTRACT VIDEO ID
      # -----------------------------------

      - name: Read video_id
        id: read_video
        run: |
          VIDEO_ID=$(python - <<EOF
          import json
          print(json.load(open("latest_video.json"))["video_id"])
          EOF
          )
          echo "VIDEO_ID=$VIDEO_ID" >> $GITHUB_ENV

      # -----------------------------------
      # TRACK PERFORMANCE
      # -----------------------------------

      - name: Track performance
        run: python - <<EOF
              import scripts.performance_tracker as pt
              pt.track_performance("${VIDEO_ID}")
              EOF
              
                    # -----------------------------------
                    # RUN OPTIMIZER
                    # -----------------------------------
              
      - name: Run adaptive optimizer
        run: python - <<EOF
              import scripts.adaptive_optimizer as ao
              ao.run_adaptive_optimization("${VIDEO_ID}")
              EOF
